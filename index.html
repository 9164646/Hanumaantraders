<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sri Hanumaan Trader's Lucky Draw</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            background: #2c3e50;
            font-family: 'Poppins', sans-serif;
            color: #fff;
            padding: 40px 0;
            margin: 0;
        }

        h1 {
            font-size: 3rem;
            color: #1E90FF;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 40px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            background: #1E90FF;
            color: #fff;
            border: none;
            padding: 14px 22px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            font-size: 1.1rem;
        }

        .btn-custom:hover {
            background: #4CAF50;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .btn-custom:focus {
            outline: none;
        }

        .hidden {
            display: none;
        }

        .table {
            background-color: #fff;
            color: #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px;
            text-align: center;
            font-size: 1rem;
        }

        th {
            background-color: #1E90FF;
            color: #fff;
            font-weight: bold;
        }

        .admin-panel {
            background: #34495e;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            margin-top: 40px;
            display: none;
        }

        .admin-panel input[type="file"] {
            margin-top: 20px;
        }

        .coupon-input input {
            width: 65%;
            margin-right: 15px;
        }

        .coupon-input button {
            width: 30%;
        }

        .winner-list {
            margin-top: 40px;
        }

        .card {
            margin-bottom: 40px;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-body {
            padding: 25px;
        }

        .alert {
            display: none;
            margin-top: 20px;
        }

        .filters {
            margin-top: 30px;
        }

        .card-header {
            background: #1E90FF;
            color: #fff;
            padding: 15px;
            border-radius: 10px 10px 0 0;
        }

        .card-footer {
            background: #f5f5f5;
            text-align: center;
            padding: 15px;
            border-radius: 0 0 10px 10px;
        }
    </style>
</head>
<body>

<audio id="drumroll" src="https://www.fesliyanstudios.com/play-mp3/387" preload="auto"></audio>
<audio id="chime" src="https://www.fesliyanstudios.com/play-mp3/438" preload="auto"></audio>

<h1>Sri Hanumaan Trader's Lucky Draw</h1>

<div class="text-center">
    <button class="btn-custom" onclick="toggleAdminPanel()">Admin Panel</button>
    <button id="startDrawBtn" class="btn-custom" onclick="startDraw()">Start Lucky Draw</button>
    <button class="btn-custom" onclick="exportWinnersPDF()">Download PDF</button>
    <button class="btn-custom" onclick="resetWinners()">Reset Winners</button>
    <button class="btn-custom" onclick="exportWinnersExcel()">Export to Excel</button>
    <button class="btn-custom" onclick="deleteAllParticipants()">Delete All Participants</button>
</div>

<div id="adminPanel" class="admin-panel">
    <h2 class="text-center text-white">Manage Participants</h2>
    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="form-control">
   <small class="text-white">Accepted file formats: .xlsx, .xls, .csv</small>
    <button class="btn-custom btn-block" onclick="uploadFile()">Upload Excel File</button>
    <hr>
    <table id="participantTable" class="table table-bordered mt-4">
        <thead><tr><th>S. No</th><th>Name</th><th>Trader Address</th><th>Coupon Code</th><th>Actions</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<div id="winnerList" class="winner-list hidden">
    <h2 class="text-center text-white">Winners List</h2>
    <div class="coupon-input text-center">
        <input type="text" id="filterCouponCode" placeholder="Enter Coupon Code to filter winners" class="form-control mb-2 d-inline-block">
        <button class="btn-custom" onclick="filterWinners()">Filter</button>
    </div>
    <table id="winnersTable" class="table table-bordered mt-4">
        <thead><tr><th>S. No</th><th>Name</th><th>Prize</th><th>Gift</th><th>Coupon Code</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let participants = JSON.parse(localStorage.getItem('participants')) || [];
    let winners = JSON.parse(localStorage.getItem('winners')) || [];

    const prizes = [
        { prize: '1st Prize - 6 Gram Gold', count: 1, gift: '6 Gram Gold' },
        { prize: '2nd Prize - 4 Gram Gold', count: 2, gift: '4 Gram Gold' },
        { prize: '3rd Prize - 3 Gram Gold', count: 3, gift: '3 Gram Gold' },
        { prize: '4th Prize - 2 Gram Gold', count: 4, gift: '2 Gram Gold' },
        { prize: '5th Prize - 1 Gram Gold', count: 5, gift: '1 Gram Gold' },
        { prize: '6th Prize - 0.5 Gram Silver', count: 6, gift: '0.5 Gram Silver' }
    ];

    function toggleAdminPanel() {
        const panel = document.getElementById('adminPanel');
        panel.classList.toggle('hidden');
        panel.style.display = panel.classList.contains('hidden') ? 'none' : 'block';
        renderTable();
    }

  function uploadFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) {
        alert('Please select a file');
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        const data = e.target.result;
        try {
            const workbook = XLSX.read(data, { type: 'binary' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);
            
            let addedCount = 0;
            let skippedCount = 0;

            // Loop through each row and validate required fields
            json.forEach(row => {
                const { Name, TraderAddress, CouponCode } = row;
                // Trim the fields (if they exist) for better validation.
                const name = Name ? Name.toString().trim() : "";
                const traderAddress = TraderAddress ? TraderAddress.toString().trim() : "";
                const couponCode = CouponCode ? CouponCode.toString().trim() : "";

                if (name && traderAddress && couponCode) {
                    // Check for duplicates before adding
                    if (!participants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                        participants.push({ name, traderAddress, couponCode });
                        addedCount++;
                    }
                } else {
                    skippedCount++;
                }
            });

            localStorage.setItem('participants', JSON.stringify(participants));
            renderTable();
            alert(`Upload complete: ${addedCount} records added, ${skippedCount} records skipped due to missing required fields.`);
        } catch (error) {
            alert("Error reading or parsing the Excel file. Please make sure the file is in the correct format.");
            console.error(error);
        }
    };
    reader.onerror = function (error) {
        alert("Error reading the file: " + error);
    };
    reader.readAsBinaryString(file);
}




    function renderTable() {
        const tbody = document.querySelector('#participantTable tbody');
        tbody.innerHTML = '';
        participants.forEach((p, i) => {
            tbody.innerHTML += `<tr>
                <td>${i + 1}</td>
                <td>${p.name}</td>
                <td>${p.traderAddress}</td>
                <td>${p.couponCode}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editParticipant(${i})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteParticipant(${i})">Delete</button>
                </td>
            </tr>`;
        });
    }

    function startDraw() {
        if (winners.length > 0) {
            alert("Lucky Draw already completed!");
            return;
        }

        prizes.forEach(prize => {
            const eligible = participants.filter(p => !winners.find(w => w.name === p.name));
            for (let i = 0; i < prize.count; i++) {
                const randomIndex = Math.floor(Math.random() * eligible.length);
                winners.push({ ...eligible.splice(randomIndex, 1)[0], prize: prize.prize, gift: prize.gift });
            }
        });

        localStorage.setItem('winners', JSON.stringify(winners));
        document.getElementById('startDrawBtn').disabled = true;
        showWinners();
    }

    function showWinners() {
        document.getElementById('winnerList').classList.remove('hidden');
        renderWinnersTable(winners);
    }

    function filterWinners() {
        const couponCode = document.getElementById('filterCouponCode').value.trim();
        const filteredWinners = couponCode ? winners.filter(w => w.couponCode === couponCode) : winners;
        renderWinnersTable(filteredWinners);
    }

    function renderWinnersTable(filteredWinners) {
        const winnersTable = document.getElementById('winnersTable').querySelector('tbody');
        winnersTable.innerHTML = '';

        filteredWinners.forEach((w, i) => {
            winnersTable.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${w.name}</td>
                    <td>${w.prize}</td>
                    <td>${w.gift}</td>
                    <td>${w.couponCode}</td>
                </tr>`;
        });
    }

    function exportWinnersPDF() {
        const docDefinition = {
            content: [
                { text: 'Sri Hanumaan Trader\'s Lucky Draw Winners', style: 'header' },
                { table: { body: [['S. No', 'Name', 'Prize', 'Gift', 'Coupon Code'], ...winners.map((w, i) => [i + 1, w.name, w.prize, w.gift, w.couponCode]) ]}, style: 'table' },
            ],
            styles: {
                header: { fontSize: 18, bold: true, alignment: 'center' },
                table: { margin: [0, 5, 0, 5], alignment: 'center' }
            }
        };
        pdfMake.createPdf(docDefinition).download('LuckyDraw_Winners.pdf');
    }

    function exportWinnersExcel() {
        const ws = XLSX.utils.json_to_sheet(winners);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Winners");
        XLSX.writeFile(wb, 'LuckyDraw_Winners.xlsx');
    }

    function deleteParticipant(index) {
        participants.splice(index, 1);
        localStorage.setItem('participants', JSON.stringify(participants));
        renderTable();
    }

    function deleteAllParticipants() {
        if (confirm("Are you sure you want to delete all participants?")) {
            participants = [];
            localStorage.setItem('participants', JSON.stringify(participants));
            renderTable();
        }
    }
</script>
</body>
</html>
