<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sri Hanumaan Trader's Lucky Draw</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <style>
        body { background: #2d2f38; color: #fff; font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        h1 { color: #1E90FF; margin-bottom: 20px; }
        .btn-custom { background: #1E90FF; color: #fff; border: none; padding: 12px 20px; margin: 5px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        .btn-custom:hover { background: #5b7dff; }
        table { width: 100%; background: #fff; color: #000; margin-top: 20px; border-radius: 8px; }
        th, td { padding: 12px; border: 1px solid #ddd; }
        .hidden { display: none; }
        .admin-panel { background: #333; padding: 15px; border-radius: 10px; margin-top: 20px; }
        .coupon-input { margin-top: 20px; }
        .coupon-input input { margin-right: 10px; padding: 10px; border-radius: 5px; }
        .winner-list { margin-top: 20px; }
    </style>
</head>
<body>
<audio id="drumroll" src="https://www.fesliyanstudios.com/play-mp3/387" preload="auto"></audio>
<audio id="chime" src="https://www.fesliyanstudios.com/play-mp3/438" preload="auto"></audio>

<h1>Sri Hanumaan Trader's Lucky Draw</h1>
<button class="btn-custom" onclick="toggleAdminPanel()">Admin Panel</button>
<button id="startDrawBtn" class="btn-custom" onclick="startDraw()">Start Lucky Draw</button>
<button class="btn-custom" onclick="exportWinnersPDF()">Download PDF</button>
<button class="btn-custom" onclick="resetWinners()">Reset Winners</button>
<button class="btn-custom" onclick="exportWinnersExcel()">Export to Excel</button>
<button class="btn-custom" onclick="deleteAllParticipants()">Delete All Participants</button>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden admin-panel">
    <h2>Manage Participants</h2>
    <input type="text" id="participantName" placeholder="Enter Name" class="form-control mb-2">
    <input type="text" id="traderAddress" placeholder="Enter Trader Address" class="form-control mb-2">
    <input type="text" id="couponCode" placeholder="Enter Coupon Code" class="form-control mb-2">
    <button class="btn-custom" onclick="addParticipant()">Add/Update</button>

    <hr>
    <table id="participantTable" class="table table-bordered mt-3">
        <thead><tr><th>S. No</th><th>Name</th><th>Trader Address</th><th>Coupon Code</th><th>Actions</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<!-- Winners Section -->
<div id="winnerList" class="winner-list hidden">
    <h2>Winners List</h2>
    <div class="coupon-input">
        <input type="text" id="filterCouponCode" placeholder="Enter Coupon Code to filter winners" class="form-control">
        <button class="btn-custom" onclick="filterWinners()">Filter</button>
    </div>
    <table id="winnersTable" class="table table-bordered mt-3">
        <thead><tr><th>S. No</th><th>Name</th><th>Prize</th><th>Gift</th><th>Coupon Code</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let participants = JSON.parse(localStorage.getItem('participants')) || [];
    let winners = JSON.parse(localStorage.getItem('winners')) || [];
    let editIndex = -1;

    const prizes = [
        { prize: '1st Prize - 6 Gram Gold', count: 1, gift: '6 Gram Gold' },
        { prize: '2nd Prize - 4 Gram Gold', count: 2, gift: '4 Gram Gold' },
        { prize: '3rd Prize - 3 Gram Gold', count: 3, gift: '3 Gram Gold' },
        { prize: '4th Prize - 2 Gram Gold', count: 4, gift: '2 Gram Gold' },
        { prize: '5th Prize - 1 Gram Gold', count: 5, gift: '1 Gram Gold' },
        { prize: '6th Prize - 0.5 Gram Silver', count: 6, gift: '0.5 Gram Silver' }
    ];

    function toggleAdminPanel() {
        document.getElementById('adminPanel').classList.toggle('hidden');
        renderTable();
    }

    function addParticipant() {
        const name = document.getElementById('participantName').value.trim();
        const traderAddress = document.getElementById('traderAddress').value.trim();
        const couponCode = document.getElementById('couponCode').value.trim();

        if (name && traderAddress && couponCode) {
            if (participants.some((p, i) => p.name.toLowerCase() === name.toLowerCase() && i !== editIndex)) {
                alert("Participant with this name already exists.");
                return;
            }
            
            if (editIndex === -1) {
                participants.push({ name, traderAddress, couponCode });
            } else {
                participants[editIndex] = { name, traderAddress, couponCode };
                editIndex = -1;
            }
            localStorage.setItem('participants', JSON.stringify(participants));
            renderTable();
        } else {
            alert("Please enter all fields.");
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#participantTable tbody');
        tbody.innerHTML = '';
        participants.forEach((p, i) => {
            tbody.innerHTML += `<tr>
                <td>${i + 1}</td>
                <td>${p.name}</td>
                <td>${p.traderAddress}</td>
                <td>${p.couponCode}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editParticipant(${i})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteParticipant(${i})">Delete</button>
                </td>
            </tr>`;
        });
    }

    function startDraw() {
        if (winners.length > 0) {
            alert("Lucky Draw already completed!");
            return;
        }

        prizes.forEach(prize => {
            const eligible = participants.filter(p => !winners.find(w => w.name === p.name));
            for (let i = 0; i < prize.count; i++) {
                const randomIndex = Math.floor(Math.random() * eligible.length);
                winners.push({ ...eligible.splice(randomIndex, 1)[0], prize: prize.prize, gift: prize.gift });
            }
        });

        localStorage.setItem('winners', JSON.stringify(winners));
        document.getElementById('startDrawBtn').disabled = true;
        showWinners();
    }

    function showWinners() {
        document.getElementById('winnerList').classList.remove('hidden');
        renderWinnersTable(winners);
    }

    function filterWinners() {
        const couponCode = document.getElementById('filterCouponCode').value.trim();
        const filteredWinners = couponCode ? winners.filter(w => w.couponCode === couponCode) : winners;
        renderWinnersTable(filteredWinners);
    }

    function renderWinnersTable(filteredWinners) {
        const winnersTable = document.getElementById('winnersTable').querySelector('tbody');
        winnersTable.innerHTML = '';

        filteredWinners.forEach((w, i) => {
            winnersTable.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${w.name}</td>
                    <td>${w.prize}</td>
                    <td>${w.gift}</td>
                    <td>${w.couponCode}</td>
                </tr>`;
        });
    }

    function exportWinnersPDF() {
        const docDefinition = {
            content: [
                { text: 'Sri Hanumaan Trader\'s Lucky Draw Winners', style: 'header' },
                { table: { body: [['S. No', 'Name', 'Prize', 'Gift', 'Coupon Code'], ...winners.map((w, i) => [i + 1, w.name, w.prize, w.gift, w.couponCode]) ]}, style: 'table' },
            ],
            styles: {
                header: { fontSize: 18, bold: true, alignment: 'center' },
                table: { margin: [0, 5, 0, 5], alignment: 'center' }
            }
        };
        pdfMake.createPdf(docDefinition).download('LuckyDraw_Winners.pdf');
    }

    function exportWinnersExcel() {
        const ws = XLSX.utils.json_to_sheet(winners);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Winners");
        XLSX.writeFile(wb, 'LuckyDraw_Winners.xlsx');
    }

    function deleteParticipant(index) {
        participants.splice(index, 1);
        localStorage.setItem('participants', JSON.stringify(participants));
        renderTable();
    }

    function deleteAllParticipants() {
        if (confirm("Are you sure you want to delete all participants?")) {
            participants = [];
            localStorage.setItem('participants', JSON.stringify(participants));
            renderTable();
        }
    }
</script>
</body>
</html>
